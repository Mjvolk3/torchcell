#!/bin/bash
#SBATCH --mem=64g
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=1
#SBATCH --cpus-per-task=64    # <- match to OMP_NUM_THREADS
#SBATCH --partition=cpu
#SBATCH --account=bbub-delta-cpu
#SBATCH --job-name=TC
#SBATCH --time=48:00:00
#SBATCH --constraint="projects&scratch"
#SBATCH --mail-user=mjvolk3@illinois.edu
#SBATCH --mail-type="END"
#SBATCH --output=/projects/bbub/mjvolk3/torchcell/database/slurm/output/%x_%j.out
#SBATCH --error=/projects/bbub/mjvolk3/torchcell/database/slurm/eroror/%x_%j.out

# mem 128g
# cpu 128
module reset
source ~/.bashrc
conda activate /projects/bbub/miniconda3/envs/torchcell\

echo "job is starting on `hostname`"

cd /scratch/bbub/mjvolk3/torchcell/database

echo "Database bulk import starting."

#apptainer exec --writable-tmpfs \
#  --env-file $(pwd)/database/.env \
#  -B $(pwd)/database/.env:/.env \
#  -B /projects/bbub/mjvolk3/torchcell/biocypher:/var/lib/neo4j/biocypher \
#  -B $(pwd)/database/biocypher-out:/var/lib/neo4j/biocypher-out \
#  -B $(pwd)/data/torchcell/:/var/lib/neo4j/data/torchcell \
#  -B $(pwd)/database/conf/neo4j.conf:/var/lib/neo4j/conf/neo4j.conf \
#  -B $(pwd)/database/data:/data \
#  -B $(pwd)/database/logs:/logs \
#  -B $(pwd)/database/import:/var/lib/import \
#  -B $(pwd)/database/plugins:/plugins \
#  $(pwd)/database/tc-neo4j.sif \
#  /bin/bash conda activate myenv 
#  & python -m pip uninstall torchcell -y
#  & python -m pip install git+https://github.com/Mjvolk3/torchcell.git@main
#  & python -m pip uninstall biocypher -y
#  & python -m pip install git+https://github.com/Mjvolk3/biocypher@main
#  & echo "----------------NOW_BUILDING_GRAPHS----------------"
#  & bash_script_path=$(python -m torchcell.knowledge_graphs.create_scerevisiae_kg_small)
#  & cd /var/lib/neo4j # this is where relative biocypher path is
#  & /bin/bash -c "chmod +x ${bash_script_path}"
#  & /bin/bash -c "${bash_script_path}"


apptainer exec --writable-tmpfs \
  --env-file $(pwd)/.env \
  -B /projects/bbub/mjvolk3/torchcell/biocypher:/var/lib/neo4j/biocypher \
  -B /projects/bbub/mjvolk3/torchcell/database/build:/var/lib/neo4j/build \
  -B $(pwd)/biocypher-out:/var/lib/neo4j/biocypher-out \
  -B $(pwd)/../data/torchcell:/var/lib/neo4j/data/torchcell \
  -B $(pwd)/conf/neo4j.conf:/var/lib/neo4j/conf/neo4j.conf \
  -B $(pwd)/data:/data \
  -B $(pwd)/logs:/logs \
  -B $(pwd)/import:/var/lib/import \
  -B $(pwd)/plugins:/plugins \
  -B $(pwd):/scripts \
  $(pwd)/tc-neo4j.sif \
  /bin/bash /var/lib/neo4j/build/build_linux-amd.sh

#apptainer exec --writable-tmpfs \
#  --env-file $(pwd)/.env \
#  -B /projects/bbub/mjvolk3/torchcell/biocypher:/var/lib/neo4j/biocypher \
#  -B $(pwd)/biocypher-out:/var/lib/neo4j/biocypher-out \
#  -B $(pwd)/../data/torchcell:/var/lib/neo4j/data/torchcell \
#  -B $(pwd)/conf/neo4j.conf:/var/lib/neo4j/conf/neo4j.conf \
#  -B $(pwd)/data:/data \
#  -B $(pwd)/logs:/logs \
#  -B $(pwd)/import:/var/lib/import \
#  -B $(pwd)/plugins:/plugins \
#  $(pwd)/tc-neo4j.sif \
#  /bin/bash -c "conda activate myenv; python -m pip uninstall torchcell -y; python -m pip install git+https://github.com/Mjvolk3/torchcell.git@main; python -m pip uninstall biocypher -y; python -m pip install git+https://github.com/Mjvolk3/biocypher@main; echo '----------------NOW_BUILDING_GRAPHS----------------'; bash_script_path=$(python -m torchcell.knowledge_graphs.create_scerevisiae_kg_small); cd /var/lib/neo4j; chmod +x ${bash_script_path}; /bin/bash -c '${bash_script_path}'"



#####
#####
# Validate the obtained bash script path
#if [ ! -f "$bash_script_path" ]; then
#    echo "The bash script does not exist: $bash_script_path"
#    exit 1
#fi

# Obtain the path to the Neo4j import script generated by the Python script
#bash_script_path=$(python /projects/bbub/mjvolk3/torchcell/torchcell/knowledge_graphs/create_scerevisiae_kg_small.py)

#bash_script_path="biocypher-out/2024-02-02_01-11-02/neo4j-admin-import-call.sh"

#echo "Bash script path: $bash_script_path"

#########

#apptainer exec --writable-tmpfs \
#  -B $(pwd)/data:/data \
#  -B $(pwd)/logs:/logs \
#  -B $(pwd)/import:/var/lib/import \
#  -B $(pwd)/biocypher-out:/biocypher-out \
#  -B $(pwd)/plugins:/plugins \
#  -B $(pwd)/neo4j.conf:/var/lib/neo4j/conf/neo4j.conf \
#  $(pwd)/tc-neo4j.sif \
#  /var/lib/neo4j/bin/neo4j start
#
## Wait for Neo4j to fully start
#sleep 15
#
## Execute the Neo4j admin import script
## Ensure you are in the correct directory and have appropriate permissions
#chmod +x "$bash_script_path"
#apptainer exec --writable-tmpfs \
#  -B $(pwd)/data:/data \
#  -B $(pwd)/logs:/logs \
#  -B $(pwd)/biocypher-out:/biocypher-out \
#  -B $(pwd)/import:/var/lib/neo4j/import \
#  -B $(pwd)/plugins:/plugins \
#  -B $(pwd)/neo4j.conf:/var/lib/neo4j/conf/neo4j.conf \
#  $(pwd)/tc-neo4j.sif \
#  /bin/bash "$bash_script_path"
#
## Stop the Neo4j database before ending the job
#apptainer exec --writable-tmpfs \
#  -B $(pwd)/data:/data \
#  -B $(pwd)/logs:/logs \
#  -B $(pwd)/biocypher-out:/biocypher-out \
#  -B $(pwd)/import:/var/lib/neo4j/import \
#  -B $(pwd)/plugins:/plugins \
#  -B $(pwd)/neo4j.conf:/var/lib/neo4j/conf/neo4j.conf \
#  $(pwd)/tc-neo4j.sif \
#  /var/lib/neo4j/bin/neo4j stop


########

# Binding for writing lmbd data to data dir.
# apptainer exec --writable-tmpfs -B /home/user/project/data:/data tc-neo4j.sif /bin/bash
# apptainer exec --writable-tmpfs \
#   -B $(pwd)/data:/data \
#   -B $(pwd)/logs:/logs \
#   -B $(pwd)/import:/var/lib/import \
#   -B $(pwd)/biocypher-out:/biocypher-out \
#   -B $(pwd)/plugins:/plugins \
#   -B $(pwd)/neo4j.conf:/var/lib/neo4j/conf/neo4j.conf \
#   $(pwd)/tc-neo4j.sif \
#   /bin/bash


########
# we want to run as if it is in local project workspace
#apptainer exec --writable-tmpfs \
#  -B $(pwd)/database/data:/data \
#  -B $(pwd)/database/logs:/logs \
#  -B $(pwd)/database/import:/var/lib/import \
#  -B $(pwd)/database/biocypher-out:/biocypher-out \
#  -B $(pwd)/database/plugins:/plugins \
#  -B $(pwd)/database/neo4j.conf:/var/lib/neo4j/conf/neo4j.conf \
#  $(pwd)/database/tc-neo4j.sif \
#  /bin/bash


##########################

#apptainer exec --writable-tmpfs \
#-B $(pwd)/database/data:/data \
#-B $(pwd)/database/logs:/logs \
#-B $(pwd)/database/import:/var/lib/import \
#-B $(pwd)/database/biocypher-out:/biocypher-out \
#-B $(pwd)/database/plugins:/plugins \
#-B $(pwd)/database/neo4j.conf:/var/lib/neo4j/conf/neo4j.conf \
#$(pwd)/database/tc-neo4j.sif \
#/bin/bash conda init
#
#apptainer exec --writable-tmpfs \
#-B $(pwd)/database/data:/data \
#-B $(pwd)/database/logs:/logs \
#-B $(pwd)/database/import:/var/lib/import \
#-B $(pwd)/database/biocypher-out:/biocypher-out \
#-B $(pwd)/database/plugins:/plugins \
#-B $(pwd)/database/neo4j.conf:/var/lib/neo4j/conf/neo4j.conf \
#$(pwd)/database/tc-neo4j.sif \
#/bin/bash conda activate myenv 
#& python -m pip uninstall torchcell -y
#& python -m pip install git+https://github.com/Mjvolk3/torchcell.git@main
#& python -m pip uninstall biocypher -y
#& python -m pip install git+https://github.com/Mjvolk3/biocypher@main
#& echo "----------------NOW_BUILDING_GRAPHS----------------"
#& bash_script_path=$(python -m torchcell.knowledge_graphs.create_scerevisiae_kg_small)
#& cd /var/lib/neo4j # this is where relative biocypher path is
#& /bin/bash -c "chmod +x ${bash_script_path}"
#& /bin/bash -c "${bash_script_path}"

######

#apptainer exec --writable-tmpfs \
#--env-file $(pwd)/database/.env \
#-B /projects/bbub/mjvolk3/torchcell/biocypher:/var/lib/neo4j/biocypher \
#-B $(pwd)/database/biocypher-out:/var/lib/neo4j/biocypher-out \
#-B $(pwd)/data/torchcell/:/var/lib/neo4j/data/torchcell \
#-B $(pwd)/database/.env:/.env \
#-B $(pwd)/database/conf/neo4j.conf:/var/lib/neo4j/conf/neo4j.conf \
#-B $(pwd)/database/data:/data \
#-B $(pwd)/database/logs:/logs \
#-B $(pwd)/database/import:/var/lib/import \
#-B $(pwd)/database/plugins:/plugins \
#$(pwd)/database/tc-neo4j.sif \
#/bin/bash
#
#apptainer exec --writable-tmpfs \
#--env-file $(pwd)/database/.env \
#-B /projects/bbub/mjvolk3/torchcell/biocypher:/var/lib/neo4j/biocypher \
#-B $(pwd)/database/biocypher-out:/var/lib/neo4j/biocypher-out \
#-B $(pwd)/data/torchcell/:/var/lib/neo4j/data/torchcell \
#-B $(pwd)/database/.env:/.env \
#-B $(pwd)/database/conf/neo4j.conf:/var/lib/neo4j/conf/neo4j.conf \
#-B $(pwd)/database/data:/data \
#-B $(pwd)/database/logs:/logs \
#-B $(pwd)/database/import:/var/lib/import \
#-B $(pwd)/database/plugins:/plugins \
#$(pwd)/database/neo4j_4.4.30-enterprise.sif \
#/bin/bash

