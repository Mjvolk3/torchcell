#!/bin/bash
#SBATCH --mem=64g
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=1
#SBATCH --cpus-per-task=64    # <- match to OMP_NUM_THREADS
#SBATCH --partition=cpu
#SBATCH --account=bbub-delta-cpu
#SBATCH --job-name=TC
#SBATCH --time=48:00:00
#SBATCH --constraint="projects&scratch"
#SBATCH --mail-user=mjvolk3@illinois.edu
#SBATCH --mail-type="END"
#SBATCH --output=/projects/bbub/mjvolk3/torchcell/database/slurm/output/%x_%j.out
#SBATCH --error=/projects/bbub/mjvolk3/torchcell/database/slurm/error/%x_%j.out

# mem 128g
# cpu 128
module reset
source ~/.bashrc
cd /projects/bbub/mjvolk3/torchcell
conda activate /projects/bbub/miniconda3/envs/torchcell

echo "job is starting on `hostname`"

# Obtain the path to the Neo4j import script generated by the Python script
# bash_script_path=$(python /projects/bbub/mjvolk3/torchcell/torchcell/knowledge_graphs/create_scerevisiae_kg_small.py)

bash_script_path="biocypher-out/2024-02-02_01-11-02/neo4j-admin-import-call.sh"


echo "Bash script path: $bash_script_path"

cd /scratch/bbub/mjvolk3/torchcell/neo4j

# Validate the obtained bash script path
if [ ! -f "$bash_script_path" ]; then
    echo "The bash script does not exist: $bash_script_path"
    exit 1
fi

apptainer exec --writable-tmpfs \
  -B $(pwd)/data:/data \
  -B $(pwd)/logs:/logs \
  -B $(pwd)/import:/var/lib/import \
  -B $(pwd)/biocypher-out:/biocypher-out \
  -B $(pwd)/plugins:/plugins \
  $(pwd)/neo4j_4.4.30_community.sif \
  /var/lib/neo4j/bin/neo4j start

# Wait for Neo4j to fully start
sleep 30

# Execute the Neo4j admin import script
# Ensure you are in the correct directory and have appropriate permissions
chmod +x "$bash_script_path"
apptainer exec --writable-tmpfs \
  -B $(pwd)/data:/data \
  -B $(pwd)/logs:/logs \
  -B $(pwd)/biocypher-out:/biocypher-out \
  -B $(pwd)/import:/var/lib/neo4j/import \
  -B $(pwd)/plugins:/plugins \
  $(pwd)/neo4j_4.4.30_community.sif \
  /bin/bash "$bash_script_path"

# Stop the Neo4j database before ending the job
apptainer exec --writable-tmpfs \
  -B $(pwd)/data:/data \
  -B $(pwd)/logs:/logs \
  -B $(pwd)/biocypher-out:/biocypher-out \
  -B $(pwd)/import:/var/lib/neo4j/import \
  -B $(pwd)/plugins:/plugins \
  $(pwd)/neo4j_4.4.30_community.sif \
  /var/lib/neo4j/bin/neo4j stop

echo "Database import complete and Neo4j shutdown."